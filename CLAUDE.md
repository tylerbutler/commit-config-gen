# CLAUDE.md

## Project Overview

**commit-config-gen** is a Go CLI tool that generates commit convention config files from a single source of truth (`commit-types.json`). It outputs configs for 7 tools: changie, commitlint, cliff, conventional-changelog, release-please, release-plz, and semantic-release.

## Architecture

### Generator Pattern

Each generator implements the `Generator` interface in `internal/generator/`:

```go
type Generator interface {
    Name() string                                                    // e.g. "changie"
    FileName() string                                                // e.g. ".changie.yaml"
    Generate(cfg *config.Config, existing []byte) ([]byte, error)    // nil existing = fresh
}
```

Generators self-register via `init()` calling `Register()`. The registry provides `All()`, `Get()`, and `Names()`.

### Adding a New Generator

1. Create `internal/generator/<name>.go` with struct implementing `Generator`
2. Add `init()` function calling `Register(&YourGenerator{})`
3. Add tests in `generator_test.go`: `Test<Name>Fresh`, `Test<Name>Merge`, `Test<Name>Idempotent`
4. Update `TestRegistryAll` expected count

### Key Design Decisions

- **Merge semantics**: When an existing config file is present, generators merge into it (preserving user customizations) rather than overwriting. Only the tool-specific sections are replaced.
- **Idempotent**: All generators must be idempotent - generating twice with the same input produces identical output.
- **Sorted type order**: `config.TypeNames()` returns types in a predefined conventional-commit order, not alphabetical.

## Project Structure

```
main.go                          # CLI entrypoint (urfave/cli)
commit-types.json                # Source of truth for commit types
internal/config/types.go         # Config loading and types
internal/generator/registry.go   # Generator interface and registry
internal/generator/<name>.go     # One file per generator
internal/generator/generator_test.go  # All generator tests
```

## Generated Files

These files are generated by `commit-config-gen` and should not be edited directly:
- `.changie.yaml` (kinds section)
- `.commitlintrc.json`

Edit `commit-types.json` instead, then run `just config-gen`.

## Commands

```bash
just ci              # Full validation: format, lint, test, build
just test            # Run tests
just format          # Format with gofumpt
just lint            # Lint with golangci-lint
just build           # Compile binary
just config-gen      # Regenerate config files from commit-types.json
just config-check    # Verify configs are in sync
```

## Tooling

Managed via [mise](https://mise.jdx.dev/) (see `.mise.toml`):
- **gofumpt** - Go formatter (stricter than gofmt)
- **golangci-lint** - Go linter
- **changie** - Changelog management
- **goreleaser** - Release automation
- **just** - Task runner

## Release Pipeline

1. Changie manages changelog entries (`.changes/` directory)
2. `release.yml` workflow creates release PRs via changie-release action
3. `auto-tag.yml` creates git tags when release PRs merge
4. `goreleaser.yml` builds and publishes releases on tag push

### Shared Actions

Release workflows use composite actions from `tylerbutler/actions` (sibling repo at `../actions/`).
Currently pinned to `@main` for both `changie-release` and `changie-auto-tag`.

### Changie Behavior

- `changie latest` returns versions with `v` prefix (e.g. `v0.1.0`) - don't double-prefix tags
- `changie batch auto` fails (exit 1) when no unreleased fragments exist - check before calling
- Unreleased fragments are `.yaml` files in `.changes/unreleased/` (configured in `.changie.yaml`)
